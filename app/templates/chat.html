{% load static %}

<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>chatroom</title>
    <script type="text/javascript" src="{% static 'draw/vendor/jquery/jquery-3.3.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'draw/vendor/paper/paper-full.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'draw/vendor/bootstrap/css/bootstrap.min.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quando&family=Titillium+Web:wght@300&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style type="text/css">
        body {
            background-color: #439B3B;
            font-family: 'Titillium Web', sans-serif;
        }

        .row.app-name p {
            color: white;
            font-size: 2rem;
            font-family: 'Quando', serif;
            margin-left: -15px;
        }

        .recive {
            background-color: #2F472F;
            text-align: center;
            font-size: 40px;
            font-family: 'Titillium Web';
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            float: left;
            padding-right: 20px;
            margin-left: 10px;
        }

        .send {
            background-color: #2F472F;
            text-align: center;
            font-size: 40px;
            font-family: 'Titillium Web';
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            float: right;
            padding-right: 20px;
            margin-right: 10px;
        }

        .icon {
            margin: 4px 4px;
            left: 95%;
            bottom: 0px;
            position: absolute;
            font-size: 40px;
        }

        #back-icon {
            position: fixed;
            bottom: 0px;
        }

        h2 {
            font-size: 40px;
            margin-left: 20px;
        }

        h1 {
            color: white;
        }

        .other {
            margin-left: 10px;
        }

        .sender {
            margin-right: 10px;
        }

        .text-input {
            position: relative;
            position: fixed;
            bottom: 0px;
            left: 25%;
            width: 50%;
        }

        input[type="text"] {
            background-color: #2F472F;
            color: white;
            border-radius: 10px;
            border: none;
        }

        input[type="text"]:focus {
            background-color: #2F472F;
            color: white;
        }

        #send {
            background-color: #2F472F;
            color: white;
            position: absolute;
            border: none;
            right: -5px;
            border-radius: 10px;
            z-index: 100;
        }

        input[type="text"]::placeholder {
            padding-left: 10px;
            color: white;
            font-size: 20px;
        }
        .overlay {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 500ms;
            visibility: hidden;
            opacity: 0;
        }
        .overlay:target {
            visibility: visible;
            opacity: 1;
        }
        .popup {
            margin: 70px auto;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            width: 30%;
            position: relative;
            transition: all 5s ease-in-out;
        }
        .popup h2 {
            margin-top: 0;
            color: #333;
            font-family: Tahoma, Arial, sans-serif;
        }
        .popup .close {
            position: absolute;
            top: 20px;
            right: 30px;
            transition: all 200ms;
            font-size: 40px;
            font-weight: bold;
            text-decoration: none;
            color: #333;
        }
        .popup .content {
            max-height: 30%;
            overflow: auto;
            font-size: 40px;
        }
        @media screen and (max-width: 700px) {
            .box {
                width: 70%;
            }
            .popup {
                width: 70%;
            }
        }
    </style>

</head>

<body onload="onLoad()">
    <div style="float:right; margin-right: 20px;">
        <a href="#popup1">
            <span class="material-icons" style="color: white; font-size: 50px;">
                menu
                </span>
        </a>
    </div>
    <div id="popup1" class="overlay">
        <div class="popup">
            <a class="close" href="#">&times;</a>
            <br>
            <br>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid;">
                <a href="http://localhost:8000/app/feed">
                    <p style="margin-left:5%">
                        Home Feed
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/newtask">
                    <p style="margin-left:5%">
                        Request Help
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/newblog">
                    <p style="margin-left:5%">
                        Add Blog Post
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/todo">
                    <p style="margin-left:5%">
                        To-Do Tasks
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/profile">
                    <p style="margin-left:5%">
                        Profile
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/privacy">
                    <p style="margin-left:5%">
                        Privacy
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/settings">
                    <p style="margin-left:5%">
                        Settings
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/help">
                    <p style="margin-left:5%">
                        Contact Us
                    </p>
                </a>
            </div>
            <div class="content" style="font-family:Titillium Web; color:white; border-width: 4px; border-color: black; border-style:solid; margin-top:-1%">
                <a href="http://localhost:8000/app/about">
                    <p style="margin-left:5%">
                        Help and About
                    </p>
                </a>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row app-name">
            <div class="col-sm-12 app-name">
                <p>Auxilium</p>
            </div>
        </div>
        <div class="row justify-content-center">
            <h1>CHATROOM</h1>
        </div>
    </div>
    <div id="back-icon">
        <span class="material-icons" onclick="back()"
            style="color: white; font-size: 4rem; padding-left: 2rem; padding-top: 1rem;">arrow_back_ios</span>
    </div>
    <div class="row">
        <div class="col-lg-4 col-lg-offset-4">
            <div class="input-group mb-3 text-input">
                <input type="text" class="form-control" placeholder="Enter Text Here" onfocus="this.placeholder = ''"
                    onblur="this.placeholder = 'Enter Text Here'" id="textToSend">
                <span class="input-group-text material-icons" id="send" onclick="sendMessage()">send</span>
            </div>
        </div>
    </div>

</body>
</body>
<script>
    /*
        Note: For sender class should have sender for message and recive for message
        Note: For sender class should have sender for message and recive for message
    */

    /*
        Data Structure use is {
            roomID -> [{
                chatMessage : String;
                userName : String;
            }]
        }
    */
    var uid = Date.now() % 10000; // Use this to ID the user
    var socket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat');

    var link = window.location.href;
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var userName = urlParams.get("username");
    var chatRoomID = urlParams.get("chatRoomId");
    var chats = localStorage.getItem("chats");

    var senderTag = "<div class='row justify-content-end sender'><h1>";
    var senderMessageTag = "<div class='send row justify-content-end'><h2>"
    var reciverTag = "<div class='row justify-content-start other'><h1>";
    var rexiverMessageTag = "<div class='recive row justify-content-start'><h2>";

    function onLoad() {
        if (chats != null) {
            chats = JSON.parse(chats);
            if (chats[chatRoomID] != undefined) {
                var chatList = chats[chatRoomID];
                for (var i = 0; i < chatList.length; i++) {
                    var chatElement = chatList[i];
                    if (chatElement.username == userName) {
                        $(".container-fluid").append("<br><br>");
                        $(".container-fluid").append(senderTag + chatElement.username + "</h1></div>");
                        $(".container-fluid").append(senderMessageTag + chatElement.messageContent + "</h2></div>");
                        $(".container-fluid").append("<br><br>");
                    } else {
                        $(".container-fluid").append("<br><br>");
                        $(".container-fluid").append(reciverTag + chatElement.username + "</h1></div>");
                        $(".container-fluid").append(rexiverMessageTag + chatElement.messageContent + "</h2></div>");
                        $(".container-fluid").append("<br><br>");
                    }
                }
            }
        }
    }
    $('#textToSend').keypress(function (event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {
            sendMessage();
        }
    });
    function sendMessage() {
        let message = $("#textToSend").val();
        var messageInfo = {
            messageContent: message,
            username: userName,
            id: chatRoomID
        }
        if (chats == null || chats[chatRoomID] == undefined) {
            if (chats == null) {
                localStorage.setItem("chats", JSON.stringify({ [chatRoomID]: [messageInfo] }));
            } else {
                var chatlist = [messageInfo];
                chats[chatRoomID] = chatlist;
                localStorage.setItem("chats", JSON.stringify(chats));
            }
        } else {
            var chatlist = chats[chatRoomID];
            chatlist.push(messageInfo);
            chats[chatRoomID] = chatlist;
            localStorage.setItem("chats", JSON.stringify(chats));
        }
        document.getElementById('textToSend').value = '';
        socket.send(JSON.stringify(messageInfo));
    }

    socket.onmessage = function (receivedMessage) {
        var received = JSON.parse(receivedMessage.data);
        console.log(received);
        if (received.id == chatRoomID) {
            window.location.reload();
            if (userName != received.username) {
                $(".container-fluid").append("<br><br>");
                $(".container-fluid").append(reciverTag + received.username + "</h1></div>");
                $(".container-fluid").append(rexiverMessageTag + received.messageContent + "</h2></div>");
                $(".container-fluid").append("<br><br>");
            } else {
                $(".container-fluid").append("<br><br>");
                $(".container-fluid").append(senderTag + received.username + "</h1></div>");
                $(".container-fluid").append(senderMessageTag + received.messageContent + "</h2></div>");
                $(".container-fluid").append("<br><br>");
            }
        }

    }

</script>

</html>